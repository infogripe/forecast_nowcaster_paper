mapa1$idarea2<-mapa1$idarea
#mapa1$idarea.year <- c(1:8415)
model<- inla(casos ~ t_mean + pre_total + ips_n_hum_bas + p_homen + Natural.Forest + log_forestloss + log_agrip + log_extr +  log_gado + Natural.Forest:log_gado + Natural.Forest:log_agrip +
f(idarea, model = "bym", graph = g)+
f(idtime, model = "iid")+
f(idtime1, model = "rw1")+
f(idarea1,model="iid",
group=idtime.int,
control.group=list(model="rw1")),
family = "nbinomial", data = mapa1, E=E,
control.predictor = list(compute = TRUE), control.compute=list(dic=TRUE, waic=TRUE, cpo=TRUE, return.marginals.predictor=TRUE))
model
summary(model)
#devtools::install_github("hesscl/coefINLA")
library(coefINLA)
devtools::install_github("hesscl/coefINLA")
library(coefINLA)
coefINLA(model, intercept =  FALSE)
#Efxplot(list(IM0.1, IM0.2)) ##testar esse daqui tb
detach("package:INLA", unload = TRUE)
remove.packages("INLA")
install.packages("C:/Users/tatty/Downloads/INLA_22.05.07.tar.gz", repos = NULL, type = "source")
#install.packages("INLA",repos=c(getOption("repos"),INLA="https://inla.r-inla-download.org/R/stable"), dep=TRUE)
library(INLA)
install.packages("C:/Users/tatty/Downloads/INLA_22.05.07.tar.gz", repos = NULL, type = "source")
detach("package:coefINLA", unload = TRUE)
model<- inla(casos ~ t_mean + pre_total + ips_n_hum_bas + p_homen + Natural.Forest + log_forestloss + log_agrip + log_extr +  log_gado + Natural.Forest:log_gado + Natural.Forest:log_agrip +
f(idarea, model = "bym", graph = g)+
f(idtime, model = "iid")+
f(idtime1, model = "rw1")+
f(idarea1,model="iid",
group=idtime.int,
control.group=list(model="rw1")),
family = "nbinomial", data = mapa1, E=E,
control.predictor = list(compute = TRUE), control.compute=list(dic=TRUE, waic=TRUE, cpo=TRUE, return.marginals.predictor=TRUE))
remotes::install_version("INLA", version="21.11.22",repos=c(getOption("repos"),INLA="https://inla.r-inla-download.org/R/stable"), dep=TRUE)
remotes::install_version("INLA", version="21.11.22",repos=c(getOption("repos"),INLA="https://inla.r-inla-download.org/R/stable"), dep=TRUE)
install.packages("C:/Users/tatty/Downloads/INLA_21.11.22.tar.gz", repos = NULL, type = "source")
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
dados<-read.csv("dados_tratados/var_final.csv")
dados2<- dados %>% select(year, casos, cod_mun, x, y, pop, pre_total, t_mean, Natural.Forest, forest_loss, extr_exc_mad, agri_perm_total, ips_n_hum_bas, cattle, p_homen)
summary(dados2[,-c(1,3:5)])
library(geobr)
library(spdep)
#install.packages("sf")
library(sf)
#library(INLA)
mun_am<-read.csv("dados_tratados/cities_am.csv")
#mun_am<- mun_am %>% filter (code_muni!="1504752" & code_muni!= "1506401" & code_muni!="1703057" & code_muni!="1716307" & cod_mun!="2101251")
cod_am<-as.list(mun_am$code_muni)
mun<-read_municipality(code_muni="all", year=2017) %>%
filter (code_muni %in% cod_am)
area<-data.frame(mun$code_muni)
area$cod_mun<-as.factor(substr(area$mun.code_muni,1,6))
area$mun_area_m2<- as.numeric(st_area(mun))
area<-area[,-1]
area$mun_area_ha<-area$mun_area_m2*0.0001 ###convertendo para ha
dados2$cod_mun<-as.factor(dados$cod_mun)
dados2<-inner_join(dados2,area, by="cod_mun")
dados2<- dados2 %>% filter (cod_mun!= 171630 & cod_mun!=150640 & cod_mun!=170305) %>%  ###municipios sem dados de agri permanente
filter (cod_mun!=150475) %>%    ###tirando municipio que não tem indicador social
# filter (cod_mun!=150475) %>% ##tirando municipio que foi criado só em 2013 (confirmar)
filter (cod_mun!=	510454 & cod_mun!=510452)  ##municipio com população 0
library(arsenal)
dtable <- tableby(~casos + pop + pre_total + t_mean + Natural.Forest + forest_loss + extr_exc_mad + agri_perm_total +  ips_n_hum_bas  + cattle + p_homen, data = dados2)
summary(dtable)
library(corrplot)
corr_dado<-cor(dados2[,-c(1,20,21,3:5)], use="complete.obs", method = "pearson")
corrplot(corr_dado, method = "number",  tl.cex=0.5, number.cex = 0.6)
library(tidyr)
library(ggplot2)
library(tidyr)
install.packages("ggplot2")
library(ggplot2)
library(tidyr)
install.packages("ggplot2")
library(ggplot2)
install.packages("devtools")
install.packages("C:/Users/tatty/Downloads/INLA_22.04.16(2).tar.gz", repos = NULL, type = "source")
install.packages("C:/Users/tatty/Downloads/INLA_22.05.07(1).tar.gz", repos = NULL, type = "source")
install.packages("C:/Users/tatty/Downloads/INLA_22.02.28-1.tar.gz", repos = NULL, type = "source")
source('http://cemin.wikidot.com/local--files/raisr/rais.r')
covid<-read.csv("output/analise/now_INLA_covid_metricas_sem_estado.csv")
install.packages("pachwork")
shiny::runApp('C:/Users/tatty/Documents/00_FIOCRUZ/infogripe-online')
runApp('C:/Users/tatty/Documents/00_FIOCRUZ/infogripe-online')
runApp('C:/Users/tatty/Documents/00_FIOCRUZ/infogripe-online')
runApp('C:/Users/tatty/Documents/00_FIOCRUZ/infogripe-online')
runApp('C:/Users/tatty/Documents/00_FIOCRUZ/infogripe-online')
runApp('C:/Users/tatty/Documents/00_FIOCRUZ/infogripe-online')
runApp('C:/Users/tatty/Documents/00_FIOCRUZ/infogripe-online')
path = "https://gitlab.fiocruz.br/marcelo.gomes/infogripe/-/raw/master/Dados/InfoGripe/casos_semanais_fx_etaria_virus_sem_filtro_febre.csv"
dados <- vroom(file = path)
path_obt = "https://gitlab.fiocruz.br/marcelo.gomes/infogripe/-/raw/master/Dados/InfoGripe/obitos_semanais_fx_etaria_virus_sem_filtro_febre.csv"
dados_obt <- vroom(file = path_obt)
ano<- dados %>% filter(epiyear=="2024")
dt_srag <- dados %>% filter(DS_UF_SIGLA==input$selected_state) %>%
filter(epiyear==2024, fx_etaria==input$selected_age)
tabela_srag<- dt_srag %>%
summarise("SRAG"=sum(SRAG),
Positivos=sum(positivos),
"Flu A"=round((sum(FLU_A)*100)/Positivos,1),
"Flu_B"=round((sum(FLU_B)*100)/Positivos,1),
"Covid-19"=round(sum(SARS2)*100/Positivos),
VSR=round((sum(VSR)*100)/Positivos,1),
Rino=round((sum(RINO)*100)/Positivos,1),
Adeno=round((sum(ADNO)*100)/Positivos,1),
Meta=round((sum(METAP)*100)/Positivos,1),
Boca=round((sum(BOCA)*100)/Positivos,1),
Paraflu=round((sum(PARA1, PARA2, PARA3, PARA4)*100)/Positivos,1),
) %>% mutate(Período="2024", .before = "SRAG") %>%
mutate(Dados="Casos", .before = "Período")
tabela_srag_4semanas<- dt_srag %>%
filter(epiweek>max_week) %>%
summarise("SRAG"=sum(SRAG),
Positivos=sum(positivos),
"Flu A"=round((sum(FLU_A)*100)/Positivos,1),
"Flu_B"=round((sum(FLU_B)*100)/Positivos,1),
"Covid-19"=round(sum(SARS2)*100/Positivos),
VSR=round((sum(VSR)*100)/Positivos,1),
Rino=round((sum(RINO)*100)/Positivos,1),
Adeno=round((sum(ADNO)*100)/Positivos,1),
Meta=round((sum(METAP)*100)/Positivos,1),
Boca=round((sum(BOCA)*100)/Positivos,1),
Paraflu=round((sum(PARA1, PARA2, PARA3, PARA4)*100)/Positivos,1),
) %>% mutate(Período="4 semanas", .before = "SRAG") %>%
mutate(Dados="Casos", .before = "Período")
tabela_srag_obt<- dt_obt %>%
summarise("SRAG"=sum(SRAG),
Positivos=sum(positivos),
"Flu A"=round((sum(FLU_A)*100)/Positivos,1),
"Flu_B"=round((sum(FLU_B)*100)/Positivos,1),
"Covid-19"=round(sum(SARS2)*100/Positivos),
VSR=round((sum(VSR)*100)/Positivos,1),
Rino=round((sum(RINO)*100)/Positivos,1),
Adeno=round((sum(ADNO)*100)/Positivos,1),
Meta=round((sum(METAP)*100)/Positivos,1),
Boca=round((sum(BOCA)*100)/Positivos,1),
Paraflu=round((sum(PARA1, PARA2, PARA3, PARA4)*100)/Positivos,1),
) %>% mutate(Período="2024", .before = "SRAG") %>%
mutate(Dados="Óbitos", .before = "Período")
tabela_srag_4semanas_obt<- dt_obt %>%
filter(epiweek>max_week) %>%
summarise("SRAG"=sum(SRAG),
Positivos=sum(positivos),
"Flu A"=round((sum(FLU_A)*100)/Positivos,1),
"Flu_B"=round((sum(FLU_B)*100)/Positivos,1),
"Covid-19"=round(sum(SARS2)*100/Positivos),
VSR=round((sum(VSR)*100)/Positivos,1),
Rino=round((sum(RINO)*100)/Positivos,1),
Adeno=round((sum(ADNO)*100)/Positivos,1),
Meta=round((sum(METAP)*100)/Positivos,1),
Boca=round((sum(BOCA)*100)/Positivos,1),
Paraflu=round((sum(PARA1, PARA2, PARA3, PARA4)*100)/Positivos,1),
) %>% mutate(Período="4 semanas", .before = "SRAG") %>%
mutate(Dados="Óbitos", .before = "Período")
junt<-bind_rows(tabela_srag, tabela_srag_4semanas, tabela_srag_obt, tabela_srag_4semanas_obt)
ano<- dados %>% filter(epiyear=="2024")
dt_srag <- dados %>% filter(DS_UF_SIGLA==input$selected_state) %>%
filter(epiyear==2024, fx_etaria==input$selected_age)
dt_srag <- dados %>% filter(DS_UF_SIGLA=="BR") %>%
filter(epiyear==2024)
dt_obt <- dados_obt %>% filter(DS_UF_SIGLA=="BR") %>%
filter(epiyear==2024)
max_week<-max(ano$epiweek)-4
tabela_srag<- dt_srag %>%
summarise("SRAG"=sum(SRAG),
Positivos=sum(positivos),
"Flu A"=round((sum(FLU_A)*100)/Positivos,1),
"Flu_B"=round((sum(FLU_B)*100)/Positivos,1),
"Covid-19"=round(sum(SARS2)*100/Positivos),
VSR=round((sum(VSR)*100)/Positivos,1),
Rino=round((sum(RINO)*100)/Positivos,1),
Adeno=round((sum(ADNO)*100)/Positivos,1),
Meta=round((sum(METAP)*100)/Positivos,1),
Boca=round((sum(BOCA)*100)/Positivos,1),
Paraflu=round((sum(PARA1, PARA2, PARA3, PARA4)*100)/Positivos,1),
) %>% mutate(Período="2024", .before = "SRAG") %>%
mutate(Dados="Casos", .before = "Período")
tabela_srag_4semanas<- dt_srag %>%
filter(epiweek>max_week) %>%
summarise("SRAG"=sum(SRAG),
Positivos=sum(positivos),
"Flu A"=round((sum(FLU_A)*100)/Positivos,1),
"Flu_B"=round((sum(FLU_B)*100)/Positivos,1),
"Covid-19"=round(sum(SARS2)*100/Positivos),
VSR=round((sum(VSR)*100)/Positivos,1),
Rino=round((sum(RINO)*100)/Positivos,1),
Adeno=round((sum(ADNO)*100)/Positivos,1),
Meta=round((sum(METAP)*100)/Positivos,1),
Boca=round((sum(BOCA)*100)/Positivos,1),
Paraflu=round((sum(PARA1, PARA2, PARA3, PARA4)*100)/Positivos,1),
) %>% mutate(Período="4 semanas", .before = "SRAG") %>%
mutate(Dados="Casos", .before = "Período")
tabela_srag_obt<- dt_obt %>%
summarise("SRAG"=sum(SRAG),
Positivos=sum(positivos),
"Flu A"=round((sum(FLU_A)*100)/Positivos,1),
"Flu_B"=round((sum(FLU_B)*100)/Positivos,1),
"Covid-19"=round(sum(SARS2)*100/Positivos),
VSR=round((sum(VSR)*100)/Positivos,1),
Rino=round((sum(RINO)*100)/Positivos,1),
Adeno=round((sum(ADNO)*100)/Positivos,1),
Meta=round((sum(METAP)*100)/Positivos,1),
Boca=round((sum(BOCA)*100)/Positivos,1),
Paraflu=round((sum(PARA1, PARA2, PARA3, PARA4)*100)/Positivos,1),
) %>% mutate(Período="2024", .before = "SRAG") %>%
mutate(Dados="Óbitos", .before = "Período")
tabela_srag_4semanas_obt<- dt_obt %>%
filter(epiweek>max_week) %>%
summarise("SRAG"=sum(SRAG),
Positivos=sum(positivos),
"Flu A"=round((sum(FLU_A)*100)/Positivos,1),
"Flu_B"=round((sum(FLU_B)*100)/Positivos,1),
"Covid-19"=round(sum(SARS2)*100/Positivos),
VSR=round((sum(VSR)*100)/Positivos,1),
Rino=round((sum(RINO)*100)/Positivos,1),
Adeno=round((sum(ADNO)*100)/Positivos,1),
Meta=round((sum(METAP)*100)/Positivos,1),
Boca=round((sum(BOCA)*100)/Positivos,1),
Paraflu=round((sum(PARA1, PARA2, PARA3, PARA4)*100)/Positivos,1),
) %>% mutate(Período="4 semanas", .before = "SRAG") %>%
mutate(Dados="Óbitos", .before = "Período")
junt<-bind_rows(tabela_srag, tabela_srag_4semanas, tabela_srag_obt, tabela_srag_4semanas_obt)
View(junt)
junt[,5:13]
junt[,5:13] <- paste(junt[,5:13], "%", sep = "")
junt[,5:13]
paste(junt[,5:13], "%", sep = "")
teste<- junt %>%
mutate_at(.cols = 5:13, funs(paste0("%", sep="")))
teste<- junt %>%
mutate_at(.vars = 5:13, funs(paste0("%", sep="")))
View(teste)
teste<- junt %>%
mutate_at(.vars = 5:13, funs(paste0(.vars, "%", sep="")))
teste<- junt %>%
mutate_at(.vars = 5:13, funs(paste0(. , "%", sep="")))
runApp('C:/Users/tatty/Documents/00_FIOCRUZ/infogripe-online')
library(glue)
library(gtsummary)
remove.packages("glue")
install.packages("glue")
install.packages("glue")
library(glue)
library(glue)
library(glue)
install.packages("glue")
library(glue)
install.packages("gtsummary")
library(gtsummary)
library(glue)
library(ggplot2)
require(geofacet)
library(patchwork)
#library(tidyverse)
library(dplyr)
library(readr)
library(readxl)
library(vroom)
library(magick)
###DAdos tratados
path = "https://gitlab.fiocruz.br/marcelo.gomes/infogripe/-/raw/master/Dados/InfoGripe/casos_semanais_fx_etaria_virus_sem_filtro_febre.csv"
dados <- vroom(file = path)
path = "https://gitlab.fiocruz.br/marcelo.gomes/infogripe/-/raw/master/Dados/InfoGripe/obitos_semanais_fx_etaria_virus_sem_filtro_febre.csv"
obt <- vroom(file = path)
teste<- dados %>%
filter(SG_UF_NOT==0) %>%
select(fx_etaria, SRAG) %>%
tbl_summary()
teste
rm(list = ls())
gc()
if(!require ('tidyverse')) {install.packages('tidyverse')};library('tidyverse')
if(!require ('data.table')) {install.packages('data.table')};library('data.table')
if(!require ('scales')) {install.packages('scales')};library('scales')
if(!require ('purrr')) {install.packages('purrr')};library('purrr')
if(!require ('readr')) {install.packages('readr')};library('readr')
if(!require ('vroom')) {install.packages('vroom')};library('vroom')
if(!require ('INLA')) {install.packages('INLA')};library('INLA')
if(!require ('doParallel')) {install.packages('doParallel')};library('doParallel')
if(!require ('sp')) {install.packages('sp')};library('sp')
if(!require ('sn')) {install.packages('sn')};library('sn')
if(!require ('snow')) {install.packages('snow')};library('snow')
n_cores <- detectCores()
cl <- makeCluster(n_cores)
registerDoParallel(cl)
library(nowcaster)
source("scripts/fct_forecast.R")
temp = list.files(pattern="boletim")
file.name<-as.list(temp)
for (j in file.name) {
data_b<-ymd(substr(j,9,18))
## Loading a base do dia
boletim<-get(load(j))
###Dados para o forecasting por CIR
dados_covid <- boletim |>
filter(classi == 'SARS COV 2') |>
mutate(date_report = pmax(DT_DIGITA, DT_PCR, na.rm = TRUE)) |>
select(DT_SIN_PRI, date_report , drs) |>
rename_with(tolower)
dados_srag <- boletim |>
mutate(date_report = pmax(DT_DIGITA, DT_NOTIFIC, na.rm = TRUE)) |>
select(DT_SIN_PRI, date_report , drs) |>
rename_with(tolower)
agregado <- unique(boletim$drs)
agregado <- sort(agregado)
rm(boletim);gc()
comb <- function(x, y) {
lapply(seq_along(x),
function(i) rbind(x[[i]], y[[i]]))
}
print("Started forecasting SRAG")
saida <- foreach (i=1:length(agregado),
.packages=c("tidyverse", "data.table", "scales", "purrr",
"readr", "vroom", "INLA", "snow", "nowcaster"), .combine="comb") %dopar% {
if(agregado[i]=="CAMPINAS" | agregado[i]=="SÃO JOSÉ DO RIO PRETO"){
dados_srag2<- dados_srag %>% filter(drs == agregado[i])
data_corte<- max(dados_srag2$dt_sin_pri)-3
dados_srag2<- dados_srag2 %>% filter(dt_sin_pri<=data_corte)
now <- nowcast_sem_correcao(data=dados_srag2, wdw=10)
}else if(agregado[i]=="GRANDE SÃO PAULO"){
dados_srag2<- dados_srag %>% filter(drs == agregado[i])
data_corte<- max(dados_srag2$dt_sin_pri)-3
dados_srag2<- dados_srag2 %>% filter(dt_sin_pri<=data_corte)
now <- nowcast_sem_correcao(data=dados_srag2, wdw=8)
}else{
## Função de Nowcasting
now <- nowcast_sem_correcao(data=dados_srag, wdw=10)
}
for_srag <-now %>% as.data.frame() %>%
mutate(base=data_b,
DRS=agregado[i],
widw="10 ou 8")
list(for_srag)  }
datalist[[j]]<-saida[1]
}
setwd("C:/Users/tatty/Documents/GitHub/forecast_nowcaster")
source("scripts/fct_forecast.R")
datalist<-list()
setwd("C:/Users/tatty/Documents/GitHub/forecast_nowcaster/bases_brutas/bases_tratadas_pre_trim/Data_2")
datalist<-list()
temp = list.files(pattern="boletim")
file.name<-as.list(temp)
for (j in file.name) {
data_b<-ymd(substr(j,9,18))
## Loading a base do dia
boletim<-get(load(j))
###Dados para o forecasting por CIR
dados_covid <- boletim |>
filter(classi == 'SARS COV 2') |>
mutate(date_report = pmax(DT_DIGITA, DT_PCR, na.rm = TRUE)) |>
select(DT_SIN_PRI, date_report , drs) |>
rename_with(tolower)
dados_srag <- boletim |>
mutate(date_report = pmax(DT_DIGITA, DT_NOTIFIC, na.rm = TRUE)) |>
select(DT_SIN_PRI, date_report , drs) |>
rename_with(tolower)
agregado <- unique(boletim$drs)
agregado <- sort(agregado)
rm(boletim);gc()
comb <- function(x, y) {
lapply(seq_along(x),
function(i) rbind(x[[i]], y[[i]]))
}
print("Started forecasting SRAG")
saida <- foreach (i=1:length(agregado),
.packages=c("tidyverse", "data.table", "scales", "purrr",
"readr", "vroom", "INLA", "snow", "nowcaster"), .combine="comb") %dopar% {
if(agregado[i]=="CAMPINAS" | agregado[i]=="SÃO JOSÉ DO RIO PRETO"){
dados_srag2<- dados_srag %>% filter(drs == agregado[i])
data_corte<- max(dados_srag2$dt_sin_pri)-3
dados_srag2<- dados_srag2 %>% filter(dt_sin_pri<=data_corte)
now <- nowcast_sem_correcao(data=dados_srag2, wdw=10)
}else if(agregado[i]=="GRANDE SÃO PAULO"){
dados_srag2<- dados_srag %>% filter(drs == agregado[i])
data_corte<- max(dados_srag2$dt_sin_pri)-3
dados_srag2<- dados_srag2 %>% filter(dt_sin_pri<=data_corte)
now <- nowcast_sem_correcao(data=dados_srag2, wdw=8)
}else{
## Função de Nowcasting
now <- nowcast_sem_correcao(data=dados_srag, wdw=10)
}
for_srag <-now %>% as.data.frame() %>%
mutate(base=data_b,
DRS=agregado[i],
widw="10 ou 8")
list(for_srag)  }
datalist[[j]]<-saida[1]
}
setwd("C:/Users/tatty/Documents/GitHub/forecast_nowcaster/output")
big_data<-bind_rows(datalist)
write.csv(big_data, "forecasting_sem_atraso_wdw10_2.csv", row.names = FALSE)
setwd("C:/Users/tatty/Documents/GitHub/forecast_nowcaster/bases_brutas/bases_tratadas_pre_trim/Data_1")
datalist<-list()
temp = list.files(pattern="boletim")
file.name<-as.list(temp)
j<-file.name[[1]]
substr(j,9,18)
substr(j,9,19)
dmy(substr(j,9,19))
dmy(substr(j,10,19))
rm(j)
datalist<-list()
temp = list.files(pattern="boletim")
file.name<-as.list(temp)
rm(j)
for (j in file.name) {
#data_b<-ymd(substr(j,9,18))
data_b<-dmy(substr(j,10,19))
## Loading a base do dia
boletim<-get(load(j))
###Dados para o forecasting por CIR
dados_covid <- boletim |>
filter(classi == 'SARS COV 2') |>
mutate(date_report = pmax(DT_DIGITA, DT_PCR, na.rm = TRUE)) |>
select(DT_SIN_PRI, date_report , drs) |>
rename_with(tolower)
dados_srag <- boletim |>
mutate(date_report = pmax(DT_DIGITA, DT_NOTIFIC, na.rm = TRUE)) |>
select(DT_SIN_PRI, date_report , drs) |>
rename_with(tolower)
agregado <- unique(boletim$drs)
agregado <- sort(agregado)
rm(boletim);gc()
comb <- function(x, y) {
lapply(seq_along(x),
function(i) rbind(x[[i]], y[[i]]))
}
print("Started forecasting SRAG")
saida <- foreach (i=1:length(agregado),
.packages=c("tidyverse", "data.table", "scales", "purrr",
"readr", "vroom", "INLA", "snow", "nowcaster"), .combine="comb") %dopar% {
if(agregado[i]=="CAMPINAS" | agregado[i]=="SÃO JOSÉ DO RIO PRETO"){
dados_srag2<- dados_srag %>% filter(drs == agregado[i])
data_corte<- max(dados_srag2$dt_sin_pri)-3
dados_srag2<- dados_srag2 %>% filter(dt_sin_pri<=data_corte)
now <- nowcast_sem_correcao(data=dados_srag2, wdw=10)
}else if(agregado[i]=="GRANDE SÃO PAULO"){
dados_srag2<- dados_srag %>% filter(drs == agregado[i])
data_corte<- max(dados_srag2$dt_sin_pri)-3
dados_srag2<- dados_srag2 %>% filter(dt_sin_pri<=data_corte)
now <- nowcast_sem_correcao(data=dados_srag2, wdw=8)
}else{
## Função de Nowcasting
now <- nowcast_sem_correcao(data=dados_srag, wdw=10)
}
for_srag <-now %>% as.data.frame() %>%
mutate(base=data_b,
DRS=agregado[i],
widw="10 ou 8")
list(for_srag)  }
datalist[[j]]<-saida[1]
}
big_data<-bind_rows(datalist)
big_data
setwd("C:/Users/tatty/Documents/GitHub/forecast_nowcaster/output")
write.csv(big_data, "forecasting_sem_atraso_wdw10_3.csv", row.names = FALSE)
setwd("C:/Users/tatty/Documents/GitHub/forecast_nowcaster/bases_brutas/bases_tratadas_pre_trim/Data_1")
temp = list.files(pattern="boletim")
file.name<-as.list(temp)
for (j in file.name) {
#data_b<-ymd(substr(j,9,18))
data_b<-dmy(substr(j,10,19))
## Loading a base do dia
boletim<-get(load(j))
###Dados para o forecasting por CIR
dados_covid <- boletim |>
filter(classi == 'SARS COV 2') |>
mutate(date_report = pmax(DT_DIGITA, DT_PCR, na.rm = TRUE)) |>
select(DT_SIN_PRI, date_report , drs) |>
rename_with(tolower)
dados_srag <- boletim |>
mutate(date_report = pmax(DT_DIGITA, DT_NOTIFIC, na.rm = TRUE)) |>
select(DT_SIN_PRI, date_report , drs) |>
rename_with(tolower)
agregado <- unique(boletim$drs)
agregado <- sort(agregado)
rm(boletim);gc()
comb <- function(x, y) {
lapply(seq_along(x),
function(i) rbind(x[[i]], y[[i]]))
}
print("Started forecasting SRAG")
saida <- foreach (i=1:length(agregado),
.packages=c("tidyverse", "data.table", "scales", "purrr",
"readr", "vroom", "INLA", "snow", "nowcaster"), .combine="comb") %dopar% {
if(agregado[i]=="CAMPINAS" | agregado[i]=="SÃO JOSÉ DO RIO PRETO"){
dados_srag2<- dados_srag %>% filter(drs == agregado[i])
data_corte<- max(dados_srag2$dt_sin_pri)-3
dados_srag2<- dados_srag2 %>% filter(dt_sin_pri<=data_corte)
now <- nowcast_sem_correcao(data=dados_srag2, wdw=30)
}else if(agregado[i]=="GRANDE SÃO PAULO"){
dados_srag2<- dados_srag %>% filter(drs == agregado[i])
data_corte<- max(dados_srag2$dt_sin_pri)-3
dados_srag2<- dados_srag2 %>% filter(dt_sin_pri<=data_corte)
now <- nowcast_sem_correcao(data=dados_srag2, wdw=30)
}else{
## Função de Nowcasting
now <- nowcast_sem_correcao(data=dados_srag, wdw=30)
}
for_srag <-now %>% as.data.frame() %>%
mutate(base=data_b,
DRS=agregado[i],
widw="30")
list(for_srag)  }
datalist[[j]]<-saida[1]
}
big_data<-bind_rows(datalist)
setwd("C:/Users/tatty/Documents/GitHub/forecast_nowcaster/output")
write.csv(big_data, "forecasting_sem_atraso_wdw30_3.csv", row.names = FALSE)
